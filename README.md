# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/styles/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Архитектура проекта
Архитектура проекта разрабатывается с помощью паттерна MVP, в котором основными слоями являются: M - модель данных, которая отвечает за работу с данными; V - компонент представления, отвечающая за отображение данных на экране; P - презентер, код которого не будет выделен в отдельный класс, а будет содержаться в основном скрипте приложения index.ts.


## Данные и типы данных, используемые в приложении

Тип для работы с классом Api

```
export type ApiPostMethods = 'POST' | 'PATCH' | 'DELETE';
```

Тип вывода данных с сервера

```
export type ApiListResponse<Type> = {
    total: number,
    items: Type[]
};
```

Интерфейс данных карточки

```
export interface IItem {
    id: string;
    title: string;
    price: number;
    category?: string;
    description?: string;
    image?: string;
}
```

Интерфейс данных отображения элементов корзины

```
export interface IBasketView {
    items: HTMLElement[];
    total: number;
    selected: string[];
    id: string;
}
```

Интерфейс данных записанных в модель

```
export interface IBasketModel {
    items: IItem[]
}
```

Интерфейс для работы с классом Form

```
export interface IFormState {
    valid: boolean;
    errors: string[];
}
```

Интерфейсы обработки данных в модальном окне заказа

```
export interface IOrderAddress {
    address: string;
    payment: string;
}
```
```
export interface IOrderContacts {
    email: string;
    phone: string;
}
```

Интерфейс отправки данных на сервер

```
export interface IOrder extends IOrderAddress, IOrderContacts {
    items: string[],
    total: number;
}
```

Типы формирования ошибки по ключам введенных данных заказа
```
export type FormErrors = Partial<Record<keyof IOrderAddress, string>>;
```
```
export type FormErrorsContacts = Partial<Record<keyof IOrderContacts, string>>;
```

Интерфейс вернувшегося post-запроса с сервера

```
export interface IOrderResult {
    id: string;
    total: number;
}
```

Интерфейс отображения данных на главной странице

```
export interface IPage {
    counter: number;
    catalog: HTMLElement[];
    locked: boolean;
}
```

Интерфейс модального окна

```
export interface IModalData {
    content: HTMLElement;
}
```



### Базовый код 
#### Класс `Api`
Предназнаячен для работы с сервером. Иммет функции получения (`get()`) и отправки (`post()`) данных.


#### Класс `EventEmitter`
Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков о наступлении события.
Класс имеет методы on ,  off ,  emit  — для подписки на событие, отписки от события и уведомления подписчиков о наступлении события соответственно.
Дополнительно реализованы методы  onAll и  offAll  — для подписки на все события и сброса всех подписчиков.
Интересным дополнением является метод  trigger , генерирующий заданное событие с заданными аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти классы будут генерировать события, не будучи при этом напрямую зависимыми от класса EventEmitter .

#### Класс `Component`
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

### Слой данных

#### Класс `ProductModel`
Данный класс отвечает за работу с данными. Конструктор принимает инстант брокера событий.
В полях класса хранятся следующие данные:
- catalog: IItem[] - массив карточек
- basket: IBasketModel - массив карточек в корзине
- order: IOrder - данные заказа для отправки на сервер
- formErrors: FormErrors - ошибки введенных данных в формах окна order 
- formErrorsContacts: FormErrorsContacts - ошибки введенных данных в формах окна contacts 

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- getItems(): IItem[] - возвращает список продуктов
- getItem(id: string): IItem - возвращает выбранный продукт
- setItems(items: IItem[]) - сохраняет продукты 
- getSelectProductBuy(item: IItem) - проверяет добавлен продукт в корзину или нет
- addProduct(item: IItem) - добавляет продукт в корзину 
- removeProduct(item: IItem) - удаляет выбранный продукт из корзины
- getTotal() - определяет общую сумму продуктов в корзине
- getProducts(): IItem[] - определяет продукты в корзине
- getIndexProduct(item: IItem) - определяет индекс элемента списка в корзине
- setOrderField(field: keyof IOrderAddress, value: string) - записывает введенные данные форм в ключи полей окна Order данного интерфейса
- clearBasket() - удаляет все продукты из корзины
- activeButton() - метод активирует при клике одну из двух кнопок способа оплаты
- validateOrder() - проверяет валидны ли поля окна Order
- setOrderContactsField(field: keyof IOrderContacts, value: string) - записывает введенные данные форм в ключи полей окна Contacts данного интерфейса
- validateOrderContacts() - проверяет валидны ли поля окна Contacts

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс `Modal`
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.  
- constructor(container: HTMLElement, events: IEvents) Конструктор принимает элемент страницы, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса
- modal: HTMLElement - элемент модального окна
- events: IEvents - брокер событий

#### Класс `Page`
Класс отвечает за вывод элементов на главную страницу. 
Поля класса:
- _counter: HTMLElement - элемент количества продуктов в коризне
- _catalog: HTMLElement - каталог карточек товаров.
- _wrapper: HTMLElement - шапка страницы
- _basket: HTMLButtonElement - кнопка корзины

Методы:
- set catalog(items:HTMLElement[]) - выводит каталог элементов
- set counter(value:number) - показывает количество продуктов в корзине
- set locked(value: boolean) - блокирует главную страницу от прокрутки при открытом модальном окне

#### Класс `Card`
Отвечает за отображение карточки, задавая в карточке название, категорию, картинку и цену. Класс используется для отображение карточек товаров на главной странице приложения. В классе устанавливается слушатель на карточку товара, в результате взаимодействия с которым генерируется открытие превью карточки товара.
Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий.
Методы:
- set title(value:string) - получаем данные для отображения название
- set image(value:string) - получаем данные для отображения изображения товара
- set category(value:string) - получаем данные для отображения категории
- set price(value:number) - получаем данные для отображения цены товара
- set id(value: string) - получаем данные для id товара

#### Класс `PreviewCard`
Отвечает за отображение превью карточки. Данный класс дополняет родительский класс Card и дополнительно задает описание товара и кнопку покупки товара, на которую вешается слушатель.
Методы: 
- set description(value:string) - получает данные для отображения описания товара
- set selectedBuy(value: boolean) - метод проверяет добавлен ли товар в корзину, если товар в корзине, то кнопку покупки делает disabled.

#### Класс `CardBasket`
Данный класс отвечает за отображение карточки продукта в корзине. В классе устанавливается слушатель на кнопку удаления, в результате взаимодействия с которой товар стоящий рядом с этой кнопкой удаляется из корзины товаров.
Методы:
- set title(value:string) - получаем данные для отображения название
- set price(value:number) - получаем данные для отображения цены товара
- set id(value: string) - получаем данные для id товара
- set indexEl(value:number) - получает данные для отображения порядкого номера товара в корзине

#### Класс `Basket`
Отвечает за отображения корзины товаров. Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр `EventEmitter` для инициации событий. В классе устанавливается слушатель на кнопку, в результате работы которой происходит переход к окну оформления заказа.
Методы:
- set items(items: HTMLElement[]) - метод получает продукты в списке элементов корзины, если их нет, то вывод сообщение о пустой корзине
- set selected(value: number) - метод проверяет корзину товаров на количество, если их нет или есть только один товар с нулевой ценой, то блокирует кнопку
- set total(total: number) - метод получает общую сумму продуктов корзины

#### Класс `Form`
Класс отвечает за отображение ошибок валидности вводимых элементов в формы и блокировку кнопки. В классе устанавливается слушатель на формы ввода данных, если данные не валидны, то выводится ошибка. Так же устанавливается слушатель на кнопку перехода к следующему окну.
Методы:
- protected onInputChange(field: keyof T, value: string) - данный метод записывает введенные данные в значение ключей интерфейса
- set valid(value: boolean) - блокирует кнопку submit, если данные не валидны
- set errors(value: string) - отображает ошибки на валидность введенных данных
- render(state: Partial<T> & IFormState) - получает форму и проверяем ее на валдность и ошибки, так же формируем объект с введенными данными 

#### Класс `Order`
Расширяет класс `Form` и отвечает за отображение оформления заказа, выбора способа оплаты и ввода адреса получателя. Устанавливаются слушатели на кнопки выбора способа оплаты. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы.
Методы: 
- set address(value: string) - получает данные поля формы адрес

#### Класс `OrderContacts`
Расширяет класс `Form` и отвечает за отображение оформления заказа, а именно полей электронной почты и телефона. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы, а так же отправляет данные на сервер для оформления заказа.
Методы:
- set phone(value: string) - метод получает данные введенные в поле ввода номера телефона
- set email(value: string) - метод получает данные введенные в поле ввода электронной почты

#### Класс `Success`
Расширяет базовый класс `Component` и отвечает за отображение подтверждения заказа, выводит общую сумму для оплаты и устанавливается слушатель на кнопку.
Методы:
- set total(total: number) - получает данные для отображения общей суммы заказа


### Слой коммуникации

#### Класс LarekAPI
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.
Методы:
- getItems (): Promise<IItem[]> - геттер получения массива элементов с сервера
- orderProducts(order:IOrder): Promise<IOrderResult> - пост-запрос заказа на сервер, в результате возвращает данные усапешного оформления заказа(id и total - общую сумму заказа)

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.


- `items:changed` - вывод и изменени карточек товаров
- `item:select `- выбор карточки товара для отображения превью в модальном окне
- `item:buy` - выбор товара для покупки (добавление в корзину)
- `basket:open` - открытие модального окна корзины
- `cardBasket-remove` - удаления выбранного товара из корзины
- `order:open` - открытие модального окна оформления заказа с формой адреса и выбором способа оплаты
- `payment-Cash:select` - выбор оплаты наличными
- `payment-Card:select` - выбор оплаты картой
- `formErrors:change` - изменение вывода ошибок форм
- `/^order\..*:change/` - изменение вводимых данных в форме адреса и выбора способа оплаты
- `order:submit` - сохранение введенных данных и переход к модальному окна контактов
- `formErrorsContacts:change` - изменение вывода ошибок форм конактов
- `/^contacts\..*:change/` - изменение вводимых данных в форме электронной почти и телефона
- `contacts:submit` - отправка данных заказа на сервер и возврат общей суммы заказа, а так же открытие модального окна с оформленным заказом
- `success:close` - закрытие модального окна с оформленным заказом
- `modal:open` - открытие модального окна и блокировка прокрутки
- `modal:close` - закрытие модального окна и разблокировка прокрутки